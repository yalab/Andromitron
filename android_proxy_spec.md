# Androidローカルプロキシアプリ仕様

## 基本機能

### 1. HTTPSプロキシサーバー
- ローカル（127.0.0.1）でプロキシサーバーを起動
- 他のアプリからの通信を中継・フィルタリング

### 2. ドメインベースのフィルタリング
- ブロックリスト方式：指定ドメインへの通信を遮断
- ホワイトリスト方式：許可されたドメインのみ通信可能
- ワイルドカード対応（*.example.com）

### 3. リアルタイム監視
- 通信ログの表示
- ブロックされた通信の統計

## 技術実装方式

### 1. VPNService利用
- AndroidのVPNServiceでシステム全体のトラフィックをキャプチャ
- パケットレベルでの制御が可能

### 2. HTTP Proxyサーバー
- OkHttpやNanoHTTPDを使用してプロキシサーバーを実装
- 手動プロキシ設定が必要

### 3. 推奨アプローチ：VPNService + TUN Interface
```
他アプリ → VPNService → TUN Interface → フィルタリング → 実際の通信
```

## アーキテクチャ

### コンポーネント構成
- **UI Layer**: Jetpack Compose
- **VPN Service**: バックグラウンド処理
- **Filter Engine**: ドメイン判定ロジック
- **Database**: Room（ブロックリスト、ログ保存）
- **Network**: OkHttp（実際の通信処理）

## UI設計

### 1. メイン画面
- ON/OFFトグル
- 現在の状態表示
- 統計情報（ブロック数、許可数）

### 2. ドメイン管理画面
- ブロックリスト編集
- インポート/エクスポート機能

### 3. ログ画面
- リアルタイム通信ログ
- フィルタ・検索機能

## セキュリティ・パフォーマンス考慮事項

### セキュリティ
- VPN権限の適切な管理
- ローカルデータの暗号化
- 設定データのバックアップ・復元

### パフォーマンス
- 非同期処理でUI応答性確保
- メモリ効率的なログ管理
- バッテリー消費の最適化

### 権限要件
- `BIND_VPN_SERVICE`
- `INTERNET`
- `FOREGROUND_SERVICE`

## HTTPS対応について

### 現在の構成での制限
1. **VPNService方式**: HTTPSトラフィックは暗号化されているため、ドメイン名の解析が困難
2. **TLS/SSL暗号化**: パケットレベルでは宛先IPアドレスのみ見える
3. **SNI（Server Name Indication）**: TLSハンドシェイク時のみドメイン名が平文で見える

### HTTPS対応の解決策

#### 1. DNS レベルでのブロック
- DNS クエリを監視・フィルタリング
- より確実にHTTPS通信も制御可能

#### 2. SNI パースィング
- TLS ClientHelloからSNIを抽出
- 暗号化前のドメイン名でフィルタリング

#### 3. ルートCA + 中間者プロキシ
- 独自CA証明書をインストール
- HTTPS通信を復号してフィルタリング
- **セキュリティリスクあり**

### 推奨アプローチ
VPNService + DNS監視 + SNI解析の組み合わせで、HTTPSにも対応できます。これなら暗号化を破ることなく効果的にブロック可能です。